(function(){var a={}.hasOwnProperty,b=function(f,d){for(var c in d){if(a.call(d,c)){f[c]=d[c]}}function e(){this.constructor=f}e.prototype=d.prototype;f.prototype=new e();f.__super__=d.prototype;return f};$(function(){var k,f,e,o,m,l,i,g,c,n,h,p,j,d;enchant();k="./sounds/bgm01.wav";o="images/enchant.png";m=["images/start.png",o,k];n=null;p=function(s,q){var u,r,t;if(q==null){q=""}s=s.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");r="[\\?&]"+s+"=([^&#]*)";u=new RegExp(r);t=u.exec(window.location.search);if(t===null){return q}else{return decodeURIComponent(t[1].replace(/\+/g," "))}};j=function(q){return Math.floor(Math.random()*q)};d=function(q){return q[j(q.length)]};e=(function(r){b(q,r);function q(z){var u,y,s,A,w,v,x,t;q.__super__.constructor.call(this);u=(function(C){b(B,C);function B(F){var E,D,G;B.__super__.constructor.call(this,F.w,F.h);G=[F.x,F.y,F.w,F.w],this.x=G[0],this.y=G[1],this.w=G[2],this.h=G[3];D=new Surface(this.w,this.h);E=D.context;E.fillStyle="#A00";E.fillRect(0,0,this.w,this.h);this.image=D}return B})(Sprite);for(y=w=0,x=z.cell_x;0<=x?w<x:w>x;y=0<=x?++w:--w){s=y*z.cell_w;A=s+z.cell_w-1;this.addChild(new u({x:s,y:0,w:1,h:320}));this.addChild(new u({x:A,y:0,w:1,h:320}))}for(y=v=0,t=z.cell_y;0<=t?v<t:v>t;y=0<=t?++v:--v){s=y*z.cell_h;A=s+z.cell_h-1;this.addChild(new u({x:0,y:s,w:320,h:1}));this.addChild(new u({x:0,y:A,w:320,h:1}))}}return q})(Group);l=(function(q){b(r,q);function r(t,u,s){this.conf=t;if(u==null){u=0}if(s==null){s=0}r.__super__.constructor.call(this,t.cell_w,t.cell_h);this.image=n.assets[o];this.frame=u;this.position=s;this.moved=false;this.on("touchstart",function(){if(!this.moved){return this.tl.fadeTo(0.5,1)}});this.on("touchend",function(){var B,w,v,D,G,E,A,F,C,z;if(!this.moved){this.tl.fadeTo(1,1);v=this.parentNode.childNodes;C=[[1,0],[0,1],[-1,0],[0,-1]];z=[];for(A=0,F=C.length;A<F;A++){B=C[A];if(this.moved){break}G=B[0],E=B[1];z.push((function(){var H,x,y;y=[];for(H=0,x=v.length;H<x;H++){w=v[H];D=w.position;if(D===this.position+G+E*this.conf.cell_x){if(w.x===320){w.position=this.position;this.position=D;this.moved=true;this.tl.moveTo((this.position%this.conf.cell_x)*this.conf.cell_w,((this.position/this.conf.cell_x)|0)*this.conf.cell_h,3,QUAD_EASEOUT);this.tl.then(function(){this.moved=false;return n.checkFinish()});break}else{y.push(void 0)}}else{y.push(void 0)}}return y}).call(this))}return z}})}return r})(Sprite);f=(function(){function q(s){var t,r,v,u;this.conf=s;this.panels=[];for(t=v=0,u=s.celles;0<=u?v<u:v>u;t=0<=u?++v:--v){r=new l(s,t);n.rootScene.addChild(r);this.panels.push(r)}this.shuffle()}q.prototype.shuffle=function(){var s,t,r;r=[];for(s=t=1;t<10;s=++t){this.do_shuffle();if(this.checkFinish()===false){break}else{r.push(void 0)}}return r};q.prototype.do_shuffle=function(){var F,G,C,r,E,D,I,H,A,z,u,B,w,t,s,v;E=(function(){v=[];for(var y=0,x=this.conf.celles;0<=x?y<x:y>x;0<=x?y++:y--){v.push(y)}return v}).apply(this);this.hideCell_idx=null;for(C=z=0,w=this.conf.celles;0<=w?z<w:z>w;C=0<=w?++z:--z){this.panels[C].position=C;this.panels[C].frame=C;this.panels[C].x=(this.panels[C].position%this.conf.cell_x)*this.conf.cell_w;this.panels[C].y=((this.panels[C].position/this.conf.cell_x)|0)*this.conf.cell_h;this.panels[C].moved=false}r=j(this.conf.celles);F=this.conf.shuffle;while(F>0){t=d([[1,0],[0,1],[-1,0],[0,-1]]),I=t[0],H=t[1];if(!((r%this.conf.cell_x===0&&I<0)||(r%this.conf.cell_x===(this.conf.cell_x-1)&&I>0)||(r<this.conf.cell_y&&H<0)||(r>(this.conf.celles-this.conf.cell_x-1)&&H>0))){G=r+I+H*this.conf.cell_x;D=E[r];E[r]=E[G];E[G]=D;r=G;F--}}this.hideCell_idx=r;for(C=u=0,s=this.conf.celles;0<=s?u<s:u>s;C=0<=s?++u:--u){this.panels[C].position=E[C];this.panels[C].x=(this.panels[C].position%this.conf.cell_x)*this.conf.cell_w;this.panels[C].y=((this.panels[C].position/this.conf.cell_x)|0)*this.conf.cell_h}if(this.hideCell_idx!==null){this.panels[this.hideCell_idx].x=this.panels[this.hideCell_idx].y=320}return n.rootScene.addChild(new e(this.conf))};q.prototype.checkFinish=function(){var s,r,u,t;r=true;for(s=u=0,t=this.conf.celles;0<=t?u<t:u>t;s=0<=t?++u:--u){if(this.panels[s].position!==parseInt(s,10)){r=false}}return r};q.prototype.gameover=function(){var r=this;this.panels[this.hideCell_idx].tl.moveTo((this.panels[this.hideCell_idx].position%this.conf.cell_x)*this.conf.cell_w,((this.panels[this.hideCell_idx].position/this.conf.cell_x)|0)*this.conf.cell_h,n.fps/2,QUAD_EASEOUT);return this.panels[this.hideCell_idx].tl.then(function(){var s,t;t=new Date().getTime()-n.startTime;alert(""+((t/1000).toFixed(2))+" 秒でクリア！");s=g();n.pushScene(s);return r.shuffle()})};return q})();c=function(){var s,r,q;r=new Scene();s=new Sprite(236,48);s.image=n.assets["images/start.png"];q=[42,136],s.x=q[0],s.y=q[1];r.addChild(s);r.addEventListener(Event.TOUCH_START,function(t){n.popScene();return n.startTime=new Date().getTime()});return r};g=function(){var s,r,q;r=new Scene();s=new Sprite(320,320);s.image=n.assets["images/enchant.png"];q=[0,0],s.x=q[0],s.y=q[1];r.addChild(s);r.addEventListener(Event.TOUCH_START,function(t){return n.popScene()});return r};h=function(){var q,u,t,s,r;u=parseInt(p("x",4),10);t=parseInt(p("y",4),10);r=parseInt(p("s",100),10);q=parseInt(p("b",1),10);return s={cell_x:u,cell_y:t,celles:u*t,cell_w:320/u,cell_h:320/t,shuffle:r,bgm:q}};n=new Game(320,320);n.fps=24;n.preload(m);i=h();n.onload=function(){var r,s,q;n.rootScene.backgroundColor="#000000";s=new f(i);n.pushScene(c());r=n.assets[k];n.checkFinish=function(){if(s.checkFinish()){return s.gameover()}};$("#bgm-on").click(function(){return q(false)});$("#bgm-off").click(function(){return q(true)});$("#shuffle").click(function(){var u,v,t,w;t=$("#cell-x").val();w=$("#cell-y").val();v=i.shuffle;u=$("#bgm-on").css("display")==="none"?0:1;return window.location="./index.html?x="+t+"&y="+w+"&s="+v+"&b="+u});q=function(t){if(t){$("#bgm-on").show();$("#bgm-off").hide();r.play();if(r.element){r._element.loop=true}if(r.src){return r.src.loop=true}}else{$("#bgm-on").hide();$("#bgm-off").show();return r.pause()}};$("#cell-x").val(i.cell_x);$("#cell-y").val(i.cell_y);return q(i.bgm===1)};return n.start()})}).call(this);