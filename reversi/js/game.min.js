(function(){var c,b,a,d;d=(function(){var f,g,e;h.STONE_IMAGE_WIDTH=50;h.STONE_IMAGE_HEIGHT=50;h.VOID="images/void.jpg";h.BLACK="images/black.jpg";h.WHITE="images/white.jpg";h.HINT_B="images/hintB.jpg";h.HINT_W="images/hintW.jpg";f=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];function h(j,k,i){this.gameSize=k!=null?k:8;this.stoneDispWidth=i!=null?i:1;this.fps=j.fps;this.num_stone=this.gameSize*this.gameSize;this.scale=this.stoneDispWidth/h.STONE_IMAGE_WIDTH;this.SPRITES=[];this.BoardState=[];this.turn=1;this.start=false;this.BlackStone=this.WhiteStone=0;this.players=[0,0];this.records=[];this.play_pos=0;this.replay_mode=false;j.preload([h.VOID,h.BLACK,h.WHITE,h.HINT_B,h.HINT_W])}h.prototype.setCPUs=function(i){this.cpus=i};h.prototype.isInBoard=function(i,j){return(i>=0)&&(i<this.gameSize)&&(j>=0)&&(j<this.gameSize)};h.prototype.xy2pos=function(i,j){return i+j*this.gameSize};h.prototype.pos2xy=function(i){return[i%this.gameSize,Math.floor(i/this.gameSize)]};h.prototype._getSprite=function(n){var q,j,i,p,o,m,l,k;m=[h.STONE_IMAGE_WIDTH,h.STONE_IMAGE_HEIGHT],i=m[0],q=m[1];j=new Sprite(i,q);j.image=new Surface(i*5,q);j.pos=n;l=this.pos2xy(n),p=l[0],o=l[1];j.frame=0;j.scale(this.scale,this.scale);k=[p*i*this.scale,o*q*this.scale],j.x=k[0],j.y=k[1];j.image.draw(enchant.Game.instance.assets[h.VOID],0,0,i,q,0,0,i,q);j.image.draw(enchant.Game.instance.assets[h.BLACK],0,0,i,q,i,0,i,q);j.image.draw(enchant.Game.instance.assets[h.WHITE],0,0,i,q,i*2,0,i,q);j.image.draw(enchant.Game.instance.assets[h.HINT_B],0,0,i,q,i*3,0,i,q);j.image.draw(enchant.Game.instance.assets[h.HINT_W],0,0,i,q,i*4,0,i,q);return j};h.prototype.createBoard=function(){var k,j,i;this.SPRITES=[];for(k=j=0,i=this.num_stone;0<=i?j<i:j>i;k=0<=i?++j:--j){this.SPRITES.push(this._getSprite(k))}this.firstScene();return this.SPRITES};h.prototype.firstScene=function(){var m,j,l,k;for(j=l=0,k=this.num_stone;0<=k?l<k:l>k;j=0<=k?++l:--l){this.SPRITES[j].frame=0;this.BoardState[j]=0}m=this.gameSize*(Math.floor(this.gameSize/2-1))+Math.floor(this.gameSize/2-1);this.SPRITES[m].frame=this.SPRITES[m+this.gameSize+1].frame=2;this.BoardState[m]=this.BoardState[m+this.gameSize+1]=-1;this.SPRITES[m+1].frame=this.SPRITES[m+this.gameSize].frame=1;this.BoardState[m+1]=this.BoardState[m+this.gameSize]=1;this.BlackStone=this.WhiteStone=2;return document.myForm.black.value=document.myForm.white.value=2};h.prototype.checkInvert=function(){var D,w,C,B,v,u,A,q,z,t,r,m,l,s,p,o,n,k,j;w=[];z=(-1)*this.turn;for(q=m=0,s=this.num_stone;0<=s?m<s:m>s;q=0<=s?++m:--m){if(this.BoardState[q]===0){p=this.pos2xy(q),t=p[0],r=p[1];for(A=l=0,o=f.length;0<=o?l<o:l>o;A=0<=o?++l:--l){n=[f[A][0],f[A][1]],v=n[0],u=n[1];k=[1,v,u],D=k[0],C=k[1],B=k[2];while(this.isInBoard(t+C,r+B)&&(this.BoardState[this.xy2pos(t+C,r+B)]===z)){j=[D+1,C+v,B+u],D=j[0],C=j[1],B=j[2]}if(this.isInBoard(t+C,r+B)&&(this.BoardState[this.xy2pos(t+C,r+B)]===this.turn)&&(D>1)){this.BoardState[q]=2;this.SPRITES[q].frame=(this.turn>0?3:4);w.push(q);break}}}}return w};h.prototype.showStone=function(k,l){var p,j,o,m,i,n;if(l==null){l={delay:0,turn:this.turn}}m=[null,null],j=m[0],o=m[1];if(l.pos){i=this.pos2xy(l.pos),j=i[0],o=i[1];n=[j+1,o+1],j=n[0],o=n[1]}p=l.turn===1?1:2;if((this.players[0]>0&&this.players[1]>0)||(this.replay_mode===true)){console.log("--- showStone["+j+", "+o+"] immediatory");return k.frame=p}else{if(k.frame!==0){console.log("--- showStone["+j+", "+o+"] (turn) delay "+l.delay);return k.tl.delay(l.delay*this.fps).scaleTo(0.1*this.scale,this.scale,0.2*this.fps).then(function(){return this.frame=p}).scaleTo(this.scale,this.scale,this.fps*0.2)}else{console.log("--- showStone["+j+", "+o+"] (set) delay "+l.delay);return k.tl.delay(l.delay*this.fps).then(function(){return this.frame=p})}}};h.prototype.putStone=function(u,D){var I,C,J,t,H,G,B,A,F,s,E,z,w,p,n,v,r,q,o,m,l,k,j;if(D==null){D={delay:0,turn:this.turn}}if(!this.start){return g("[スタート！]を押してください！")}else{if((this.replay_mode===false)&&(this.BoardState[u]!==2)){return g("置けません！")}else{for(F=p=0,v=this.num_stone;0<=v?p<v:p>v;F=0<=v?++p:--p){if(this.BoardState[F]===2){this.BoardState[F]=0;this.SPRITES[F].frame=0}}r=this.pos2xy(u),z=r[0],w=r[1];g("("+(z+1)+", "+(w+1)+") に置きました！");this.recordPlay([this.turn,z+1,w+1]);E=(-1)*this.turn;for(F=n=0,q=f.length;0<=q?n<q:n>q;F=0<=q?++n:--n){o=[f[F][0],f[F][1]],B=o[0],A=o[1];m=[1,B,A],I=m[0],H=m[1],G=m[2];while(this.isInBoard(z+H,w+G)&&(this.BoardState[this.xy2pos(z+H,w+G)]===E)){l=[I+1,H+B,G+A],I=l[0],H=l[1],G=l[2]}if(this.isInBoard(z+H,w+G)&&(this.BoardState[this.xy2pos(z+H,w+G)]===this.turn)){k=[I-1,H-B,G-A],I=k[0],H=k[1],G=k[2];while(I>0){this.BoardState[this.xy2pos(z+H,w+G)]=this.turn;if(this.turn>0){this.BlackStone++;this.WhiteStone--}else{this.WhiteStone++;this.BlackStone--}s=this.xy2pos(z+H,w+G);this.showStone(this.SPRITES[s],{delay:D.delay+0.3,turn:this.turn,pos:s});j=[I-1,H-B,G-A],I=j[0],H=j[1],G=j[2]}}}this.BoardState[u]=this.turn;if(!this.SPRITES[u]){alert(u)}this.showStone(this.SPRITES[u],{delay:D.delay,turn:this.turn,pos:u});if(this.turn>0){this.BlackStone++}else{this.WhiteStone++}document.myForm.black.value=this.BlackStone;document.myForm.white.value=this.WhiteStone;this.turn*=-1;C=this.checkInvert();if(C.length===0){g(this.turn>0?"先手はパスです！":"後手はパスです！");this.recordPlay([this.turn,0,0]);this.turn*=-1;C=this.checkInvert();if(C.length===0){g("終了");e("はじめから");return}}if(((this.turn===1&&this.players[0]>0)||(this.turn===-1&&this.players[1]>0))&&(this.replay_mode===false)){J=this.turn===1?this.players[0]-1:this.players[1]-1;t=this.cpus[J].play(this.BoardState.slice(0),{turn:this.turn,canPuts:C.slice(0)});if(t!==null){return this.putStone(t,{delay:D.delay+0.8,turn:this.turn})}}}}};h.prototype.recordPlay=function(i){if(!this.replay_mode){if(this.play_pos!==this.records.length){this.records=this.records.slice(0,this.play_pos)}this.records.push(i);return this.play_pos=this.records.length}};h.prototype.exitReplay=function(){return this.replay_mode=false};h.prototype.replay=function(n,j){var k,m,l;this.replay_mode=true;this.firstScene();this.turn=1;if(j<0){j=0}if(j>n.length){j=n.length}if(j>0){for(k=l=0;0<=j?l<j:l>j;k=0<=j?++l:--l){m=(n[k][1]-1)+(n[k][2]-1)*this.gameSize;if(m>=0){this.turn=n[k][0];this.putStone(m)}}}if(j<=0){g("初期画面を表示しています。")}this.play_pos=j;return this.replay_mode=false};h.prototype.historyTop=function(){return this.replay(this.records,0)};h.prototype.historyLast=function(){return this.replay(this.records,this.records.length)};h.prototype.history=function(i){return this.replay(this.records,this.play_pos+i)};h.prototype.savePlay=function(){return alert(JSON.stringify({black:this.BlackStone,white:this.WhiteStone,play:this.records}))};h.prototype.loadPlay=function(){return console.log("未実装")};h.prototype.setPlayers=function(){return this.players=[document.myForm.first.selectedIndex,document.myForm.second.selectedIndex]};h.prototype.gameStart=function(){var i;if(!this.start){this.setPlayers();this.start=true;this.records=[];this.play_pos=0;g("ゲームスタート！！");e("やりなおす");i=this.checkInvert();if(this.players[0]>0&&i.length>0){return this.putStone(this.cpus[this.players[0]-1].play(this.BoardState.slice(0),{turn:this.turn,canPuts:i.slice(0)}))}}else{if(confirm("本当にやり直しますか？")){this.firstScene();this.turn=1;this.start=false;e("スタート！");return g("やりなおしました")}}};g=function(i){return document.myForm.myMsg.value=i};e=function(i){return document.myForm.start.value=i};return h})();enchant();window.onload=function(){var e,g,f,h;f=8;g=320;e=new Core(g+10,g+10);h=new d(e,f,Math.floor(g/f));this.reversi=h;h.setCPUs([new c(),new a(),new b()].slice(0));e.onload=function(){var l,k,m,j,i;l=h.createBoard();i=[];for(m=0,j=l.length;m<j;m++){k=l[m];e.rootScene.addChild(k);i.push(k.addEventListener("touchend",function(){h.exitReplay();h.setPlayers();return h.putStone(this.pos)}))}return i};return e.start()};c=(function(){function e(){}e.prototype.play=function(g,f){if(f==null){f={}}if(f.canPuts.length===0){return null}else{return f.canPuts[0]}};return e})();a=(function(){function e(){}e.prototype.play=function(g,f){if(f==null){f={}}if(f.canPuts.length===0){return null}else{return f.canPuts[Math.floor(Math.random()*f.canPuts.length)]}};return e})();b=(function(){var f;function e(){}f=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]];e.prototype.numStone=64;e.prototype.gameSize=8;e.prototype.play=function(h,g){var u,q,k,p,s,j,r,n,m,t,o,l;if(g==null){g={}}r=g.turn;u=null;k={};q=-1;for(p=n=0,o=this.numStone;0<=o?n<o:n>o;p=0<=o?++n:--n){if(h[p]===2){h[p]=0}}l=g.canPuts;for(m=0,t=l.length;m<t;m++){s=l[m];j=this.putStone(h,s,r,false);if(q<j){q=j}if(k[j]){k[j].push(s)}else{k[j]=[s]}}console.log(k);if(q<=0){return null}return k[q][Math.floor(Math.random()*k[q].length)]};e.prototype.xy2pos=function(g,h){return g+h*this.gameSize};e.prototype.pos2xy=function(g){return[g%this.gameSize,Math.floor(g/this.gameSize)]};e.prototype.isInBoard=function(g,h){return(g>=0)&&(g<this.gameSize)&&(h>=0)&&(h<this.gameSize)};e.prototype.putStone=function(C,o,v,q){var E,D,B,w,u,p,A,z,t,r,l,s,n,m,k,j,h,g;if(q==null){q=false}if(C[o]!==0){return -1}z=v*(-1);p=0;s=this.pos2xy(o),t=s[0],r=s[1];for(A=l=0,n=f.length;0<=n?l<n:l>n;A=0<=n?++l:--l){m=[f[A][0],f[A][1]],w=m[0],u=m[1];k=[1,w,u],E=k[0],D=k[1],B=k[2];while(this.isInBoard(t+D,r+B)&&(C[this.xy2pos(t+D,r+B)]===z)){j=[E+1,D+w,B+u],E=j[0],D=j[1],B=j[2]}if(C[this.xy2pos(t+D,r+B)]===v){h=[E-1,D-w,B-u],E=h[0],D=h[1],B=h[2];while(E>0){if(q){C[this.xy2pos(t+D,r+B)]=v}g=[E-1,D-w,B-u],E=g[0],D=g[1],B=g[2];p++}}}if(q){C[o]=v}return p};return e})()}).call(this);